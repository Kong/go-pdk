name: Tests

on:
  push:
    paths-ignore:
      - "*.md"
  pull_request:
    paths-ignore:
      - "*.md"

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        include:
        - golang: '^1.18'

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: "${{ matrix.golang }}"
          cache: true
      - run: go version
      
      - name: install protobuf compiler
        run: |
          go version
          wget https://github.com/protocolbuffers/protobuf/releases/download/v21.7/protoc-21.7-linux-x86_64.zip
          unzip protoc-21.7-linux-x86_64.zip
          sudo cp bin/protoc /usr/bin/
          sudo cp -Rf include/* /usr/include
          wget https://github.com/protocolbuffers/protobuf-go/releases/download/v1.28.1/protoc-gen-go.v1.28.1.linux.amd64.tar.gz
          tar -xf protoc-gen-go.v1.28.1.linux.amd64.tar.gz
          sudo cp bin/protoc-gen-go /usr/bin/

      - name: Dependency
        run: make dep

      - name: Lint
        uses: golangci/golangci-lint-action@v3
        with:
         args: --exclude composites

      - name: Test
        run: make test
